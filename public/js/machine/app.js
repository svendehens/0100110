const TEST_MODE=!0,MAX_RESULTS_PER_BOX=15,MAX_SEARCH_RESULTS=75,WINDOW_WIDTH=250,WINDOW_HEIGHT=300,WRITE_WINDOW_WIDTH=400,WRITE_WINDOW_HEIGHT=250,TIMING_HINT_IMAGE=5e3,TIMING_HINT_IMAGE_FADEOUT=3e3,TIMING_HINT_IMAGE_ONSCREEN=5e3,TIMING_TYPEIN_WORD=3e3,TIMING_HINT_MESSAGE_1=15e3,HINT_MESSAGE_1=["well, waiting got you this far, but not much further, so select one of the text excerpts that look like they could be interesting.","ok, find a text that looks like it could be interesting. click on it.","which of the excerpts above look promising to you? click on it."],HINT_MESSAGE_2=["this is the paragraph which hosted the excerpt..now, find another text. if theres nothing that looks attractive, try scrolling through any of the columns of examples til you find one and click on that.","find another text fragment that looks promising. click.","now click on another text that seems interesting."],HINT_MESSAGE_3=["if either of these new text windows need to be moved, just grab the L (ikon) in the upper left of the text window and move it.anyway, now in these two texts you'll see the original searchterm ('search', remember), underlined. click and drag one ‘search’ to the other. a blue line and a blue text. a synthesis of the two."],HINT_MESSAGE_4=["also at the top of this text area, to the right, you’ll find the title of the work from which this paragraph was taken. a click on that will bring up a larger excerpt of the text, but before you do that, below the author and title is a line with a slider. click the crossbar and slide to the right. constious words will be highlighted gray. it calculates relevance. the further right, the larger the scope of relevance. link any two highlighted words from any two texts. red line and text. link red and red or blue, green text.the synonyms and wikipedia and twitter associations you dont need me for."],ELIZA_MESSAGES=["does %word interest you?","what does %word suggest to you?","is %word much on your mind?","do you feel strongly discussing about %word?"],BY_TERM_JSON="https://test.wikipedia.org/w/api.php?action=query&format=json&origin=*&titles=",THES_JSON="http://words.bighugelabs.com/api/2/173aaf6b8cc559ac582b75f5ef7a8c8c/",WIKI_API_URL="http://en.wikipedia.org/w/api.php?action=query&prop=revisions&rvprop=content&rvslots=*&format=json&pageids=",MARKOV_URL="",SEARCH_ALL_URL="",SEARCH_URL="",LIST_URL="",BLUE_ENDPOINT_OPTS={endpoint:"Rectangle",paintStyle:{width:25,height:20,fillStyle:"#555"},isSource:!0,connectorStyle:{strokeStyle:"#00F"},isTarget:!0,anchor:"TopCenter"},RED_ENDPOINT_OPTS={endpoint:"Rectangle",paintStyle:{width:25,height:20,fillStyle:"#555"},isSource:!0,connectorStyle:{strokeStyle:"#F00"},isTarget:!0,anchor:"TopCenter"},GREEN_ENDPOINT_OPTS={endpoint:"Rectangle",paintStyle:{width:25,height:20,fillStyle:"#555"},isSource:!0,connectorStyle:{strokeStyle:"#00FF00"},isTarget:!0,anchor:"TopCenter"};let descriptionWindow=[],grids=[],writingBox=null,suggestionBox=null,suggestionList="",searchCount=0,openedTextCount=0,linksMade=0,no_action=!0,texts_opened=0,synths_made=0,nonblue_synths_made=0,windowIndex=0,blueTexts={},desktop_demo=!1,idle=!0;var browser=function(){var e,t=navigator.userAgent,n=t.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(n[1])?{name:"IE",version:(e=/\brv[ :]+(\d+)/g.exec(t)||[])[1]||""}:"Chrome"===n[1]&&null!=(e=t.match(/\bOPR|Edge\/(\d+)/))?{name:"Opera",version:e[1]}:(n=n[2]?[n[1],n[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(e=t.match(/version\/(\d+)/i))&&n.splice(1,1,e[1]),{name:n[0],version:n[1]})}();function sortJSON(e,t){return null==e.outLinks?null:"relatedness"==t?e.outLinks.sort((function(e,t){return parseFloat(t.relatedness)-parseFloat(e.relatedness)})):e.outLinks.sort((function(e,t){return e.title>t.title?1:-1}))}function checkRegexp(e,t,n){return!!t.test(e.val())}function scrollToAnchor(e,t,n){var i=$("#"+n+" a[name='"+e+"']");t.animate({scrollTop:i.offset().top-80},"fast")}function getURLParameter(e){return decodeURI((RegExp(e+"=(.+?)(&|$)").exec(location.search)||[,null])[1])}var autoRefresh=function(e){var t,n=function(){clearInterval(t),t=setTimeout((function(){location.href=location.href}),1e3*e)};$(document).on("keypress, click, mousemove",(function(){n(),detectFirstActivity()})),n()};function generateMarkov(e,t,n,i,o,r){var a=openWindow(t,n,2e3,250,300,"<div class='red_text_cont'>..."+e+"...</div>","","red_text",!0),s=a.window.getContainer().find(".red_text_cont").height();a.window.resize(250,s+40),$(a.window.getContainer()).find(".window_frame").height(s+30),$(a.window.getContainer()).find(".window_frame").highlight(i),$(a.window.getContainer()).find(".window_frame").highlight(o),jsPlumb.addEndpoint($("#"+a.window.getContainer().attr("id")+" .highlight"),GREEN_ENDPOINT_OPTS),jsPlumb.draggable(a.window.getContainer()),blueTexts[r.source]=a}function triggerHintImage(e){setTimeout((function(){no_action&&($(".hint_screenshot").css("display","block"),$(".hint_screenshot").animate({opacity:1},2e3),setTimeout((function(){no_action&&$(".hint_screenshot").animate({opacity:0},3e3,(function(){$(".hint_screenshot").css("display","none"),setTimeout((function(){no_action&&0==$("#search_box").val().length&&typeInSearch()}),3e3)}))}),5e3))}),e)}function typeInSearch(){var e="search";$("#search_box").val(""),showText("#search_box",e,0,400,!0),setTimeout((function(){search($("#search_box"))}),400*(e.length+2))}$((function(){$("#test").text("The DOM is now loaded and can be manipulated."),"MSIE"!=browser.name&&"Edge"!=browser.name||alert("machine for making sense has been designed and tested on Firefox and Chrome"),$("#search_box").val(""),openWriteBox(),typeInSearch(),$(".search_box").trigger("click"),jsPlumb.ready((function(){jsPlumb.Defaults.Container=$("body"),jsPlumb.importDefaults({ConnectorZIndex:4e3,Connector:"Straight",PaintStyle:{lineWidth:1,strokeStyle:"#00F"},Anchors:["TopCenter","BottomCenter"]}),jsPlumb.bind("jsPlumbConnection",(function(e){$(".window_frame #hint_message").fadeOut(500),$(".window_frame #hint_message").text(""),synths_made++,console.log(synths_made);const t=e.source.parent().text(),n=e.target.parent().text(),i=e.source.parents(".window_panel"),o=e.target.parents(".window_panel"),r=(e.source.position().left+e.target.position().left+i.position().left+o.position().left)/2-125,a=(e.source.position().top+e.target.position().top+i.position().top+o.position().top)/2-50;if(e.source.hasClass("wm_wikifiedLink")){nonblue_synths_made++;e.source.text(),e.target.text();e.source.css("color","#F00"),e.target.css("color","#F00")}else{const i=e.source.parents(".red_text").length>0||e.source.parents(".blue_text").length>0||e.target.parents(".red_text").length>0||e.target.parents(".blue_text").length>0?"green":"blue",o=Math.round((t.length+n.length)/2),s="blue"==i?6:4;"blue"==i&&0==nonblue_synths_made&&setTimeout((function(){0==nonblue_synths_made&&writeHintMessage(4)}),1e4),$.ajax({url:"markov.php?order="+s+"&begining="+e.source.text()+"&length="+o+"&content="+t+" "+n,context:document.body}).done((function(t){var n=openWindow(r,a,2e3,250,300,"<div class='"+i+"_text_cont'>..."+t+"...</div>","",i+"_text",!0),o=n.window.getContainer().find("."+i+"_text_cont").height();n.window.resize(250,o+40),$(n.window.getContainer()).find(".window_frame").height(o+30),blueTexts[e.source]=n,"green"!=i&&($(n.window.getContainer()).find(".window_frame").highlight(e.source.text()),$(n.window.getContainer()).find(".window_frame").highlight(e.target.text()),jsPlumb.addEndpoint($("#"+n.window.getContainer().attr("id")+" .highlight"),GREEN_ENDPOINT_OPTS),jsPlumb.draggable(n.window.getContainer()))})),e.source.css("color","#00F"),e.target.css("color","#00F")}linksMade++})),jsPlumb.bind("jsPlumbConnectionDetached",(function(e){e.source.css("color","#666"),e.target.css("color","#666"),blueTexts[e.source].window.close()}))}))}));var showTextBusy="",showText=function(e,t,n,i,o){if(showTextBusy==t||""==showTextBusy)if(showTextBusy=t,n<t.length){var r=o?$(e).val():$(e).text();o?$(e).val(r+t[n++]):$(e).text(r+t[n++]),setTimeout((function(){showText(e,t,n,i,o)}),i)}else n==t.length&&(showTextBusy="")};function addSelectionToBox(){var e=getSelectedText(),t=$.trim($(".window_container .write_note_box").val());t=t+" "+e,$(".window_container .write_note_box").val(t)}function getSelectedText(){return window.getSelection?window.getSelection():document.selection?document.selection.createRange().text:""}function openWriteBox(){let e=$(window).height()-250-5,t=$(window).width()/2-200;if(null==writingBox){let n=$("#write_window").html();writingBox=$.window({title:" ",content:n,resizable:!0,width:400,height:250,x:t,y:e,z:3e3,containerClass:"write_container",afterResize:function(e){let t=e.getContainer()[0].offsetWidth-50,n=e.getContainer()[0].offsetHeight-80;$(e.getContainer().find(".write_note_box")[0]).css("width",t+"px"),$(e.getContainer().find(".write_note_box")[0]).css("height",n+"px")}}),writingBox.getHeader().find(".minimizeImg").css("display","block"),writingBox.getHeader().find(".closeImg").css("display","none")}else writingBox.isMinimized()&&writingBox.restore();return!1}function getGridForElement(e){var t=$(e).parents(".window_container"),n=$(t).find(".grid_index").val();return textContent=grids[n]}function openWindow(e,t,n,i,o,r,a,s,l){return descriptionWindow[windowIndex]=$.window({title:null!=a?a:" ",content:r,resizable:!0,width:i,height:o,x:e,y:t,resizable:l,containerClass:s}),grids[windowIndex]=new GridElement(windowIndex,descriptionWindow[windowIndex]),windowIndex++,grids[windowIndex-1]}function search(e){no_action=!1;var t=$("#search_box").val();return t.length<2||(searchByTerm(t),openWriteBox(),setTimeout((function(){0==texts_opened&&writeHintMessage(1)}),15e3)),!1}function writeHintMessage(e){if(""==showTextBusy){var t;switch($(".window_frame #hint_message").show(),$(".window_frame #hint_message").text(""),e){case 1:t=HINT_MESSAGE_1;break;case 2:t=HINT_MESSAGE_2;break;case 3:t=HINT_MESSAGE_3;break;case 4:t=HINT_MESSAGE_4;break;default:t=ELIZA_MESSAGES,e=e.toLowerCase()}var n=t[Math.round(10*Math.random())%t.length]+" \t \n";n=n.replace("%word",e);showText(".window_frame #hint_message",n,0,80,!1);n.length}}function searchByTerm(e){$(".window_frame #hint_message").text("");e.indexOf(",")>0&&(e.substring(0,e.indexOf(",")).trim(),e=e.substring(e.indexOf(",")+1).trim()),suggestionList=""}function searchTwitterCallback(){return function(e){e.results.length>0&&$(".window_frame #twitter_result").text(e.results[0].text)}}function searchCallback(e){return function(t){var n="";0==t.length&&(n="No results");var i="",o=0,r=0,a=0,s=0,l=t.length>75?75/t.length:1;$.each(t,(function(d,c){console.log("callback each data",c);var h="";if(h=(h=(h=h+"<li>"+c.author+", "+c.title)+'<input type="hidden" id="search_result_hidden_index" value="'+c.wordIndex+'"/>')+'<p><a href="#" onclick="search_result(this,'+c.id+","+c.wordIndex+",'"+e+"');return false;\">"+c.sentence+"</a></p></li>",l<1?i==c.author?r++:Math.random()<1?(n+=h,a++,o++):r++:(n+=h,o++,a++),i=c.author,o>15||r+a==t.length){n='<div class="window_container"><div class="result_container"><ul class="results_box">'+n+"</ul></div></div>";var u=300+40*Math.random(),w=250*s*.91+searchCount%2*250/2+10,g=55+30*Math.random()-15+searchCount%4*100;w+250+20>$(document).width()&&(g+=50,w%=$(document).width());var _=openWindow(w,g,2e3,250,u,n,"","search_container",!0).window;$(_.getContainer()).find(".results_box p").highlight(e,{wordsOnly:!0}),n="",s++,o=0}})),t.length>0&&searchCount++,$(".search_box")[0].value="",$(".write_container .write_note_box").focus()}}function search_result(e,t,n,i){var o=e.parentNode.parentNode;return $.getJSON("search2.php?id="+t+"&wordIndex="+n,searchResultCallback($(o),i,-1==n)),texts_opened++,$(".window_frame #hint_message").fadeOut(500),$(".window_frame #hint_message").text(""),1==texts_opened&&setTimeout((function(){1==texts_opened&&writeHintMessage(2)}),5e3),2==texts_opened&&0==synths_made&&setTimeout((function(){0==synths_made&&writeHintMessage(3)}),5e3),!1}function searchResultCallback(e,t,n){return function(i){var o,r=i[0],a=r.body,s="text_section";n&&(s+=" large_text_section"),a.replace(/â€™/g,"'"),o='<div class="'+s+'"><h2><a href="#" onclick="list_titles(this,\''+t+"','"+r.author+"');return false;\">"+r.author+'</a>, <a href="#" onclick="search_result(this,'+r.id+",-1,'"+t+"');return false\">"+r.title+'</a></h2><div class="wikify_slider"></div><p>'+a+"</p></div>";var l=$(e).parents(".window_panel"),d=$(l).position().top;createWindow($(l).position().left,d,o,t)}}function createWindow(e,t,n,i){t<5&&(t=5),(e=e+250+20+20*Math.random())+250>$(document).width()&&(e-=500);var o=openWindow(e,t,2e3,250,300,n,"","result_box",!0).window,r=12+openedTextCount%3+"px";openedTextCount++,$(o.getContainer()).find(".text_section").css("line-height",r);var a=$(o.getContainer()).find(".text_section").height()+30;a<800?(o.resize(250,1.1*a+20),$(o.getContainer()).find(".window_frame").height(a+15)):console.log("height: large"),$(o.getContainer()).find(".wikify_slider").slider({max:100,value:0,stop:function(e,t){var n=$(e.target).parents(".window_frame").find(".text_section p");wikifyText(n.text(),1-t.value/100,n)}}),$(o.getContainer()).find(".wikify_slider a").attr("title","slide for relevance"),""!=i&&($(o.getContainer()).find(".text_section p").highlight(i,{wordsOnly:!0}),jsPlumb.addEndpoint($("#"+o.getContainer().attr("id")+" .highlight"),BLUE_ENDPOINT_OPTS),linksMade<3?($("#"+o.getContainer().attr("id")+" .highlight").attr("title","drag to any other anchor word to link"),$("._jsPlumb_endpoint").attr("title","drag to any other anchor word to link")):linksMade>=3&&($(".highlight").attr("title",""),$("._jsPlumb_endpoint").attr("title","")),jsPlumb.draggable(o.getContainer()))}function wikifyText(e,t,n){console.log("cannot wikify")}function wikifyCallback(e,t){var n=t.parents(".window_panel"),i=t.parents(".window_frame").find(".highlight"),o=i.length>0?$(i[0]).text():void 0;t.html(e),o&&(n.find(".window_frame p").highlight(o),jsPlumb.addEndpoint($("#"+n.attr("id")+" .highlight"),BLUE_ENDPOINT_OPTS)),jsPlumb.addEndpoint($("#"+n.attr("id")+" .wm_wikifiedLink"),RED_ENDPOINT_OPTS),jsPlumb.draggable(n),$(n).find(".window_frame").scroll((function(){$.doTimeout("scroll",1e3,(function(){console.log("scroll"),jsPlumb.repaintEverything()}))})),linksMade<3?($("#"+n.attr("id")+" .wm_wikifiedLink").attr("title","drag to any other anchor word to synthesize"),$("._jsPlumb_endpoint").attr("title","drag to any other anchor word to synthesize")):linksMade>=3&&($(".highlight").attr("title",""),$("._jsPlumb_endpoint").attr("title","")),t.find(".wm_wikifiedLink").click((function(e){return queryWikipediaApiById($(e.target).parents(".window_panel").position().left,$(e.target).parents(".window_panel").position().top,$(e.target).attr("pageId")),!1}))}function queryWikipediaApiById(e,t,n){return $.ajax({type:"GET",url:WIKI_API_URL+n,dataType:"json",success:function(i){openWikiWindow(i,e,t,n)}}),!1}function openWikiWindow(e,t,n,i){var o=e.query.search[0].snippet,r=txtwiki.parseWikitext(o);console.log("plainwiki:",r),r=r.replace(/{{(.*?)}}/g,""),console.log("plainwiki clean:",r);var a=`<div class="wikify_slider"></div>\n        <div class="text_section">\n          <h2>${e.query.search[0].title}</h2>\n          <p>${r}</p>\n        </div>`;0==t&&0==n&&(t=20+200*Math.random(),n=30+50*Math.random()),writeHintMessage(e.query.search[0].title),setTimeout((function(){""==showTextBusy&&$(".window_frame #hint_message").text("")}),7e3),createWindow(t,n,a,"")}function searchResultNewBox(e,t){var n=getGridForElement(e).window.getContainer()[0],i=openAdjacentWindow(e,$("#desc_window").html(),n),o=$(e.parentNode.parentNode).find(".search_result_hidden")[0].value;i.changeMode("search_result");var r=descriptionWindow[windowIndex-1].getFrame().find("ul");$.getJSON("search2.php?id="+o,searchResultCallback(r))}function list_titles(e,t,n){var i=e.parentNode.parentNode;return $.getJSON("list.php",listTitlesCallback($(i),t,n)),!1}function listTitlesCallback(e,t,n){return function(i){var o='<ul class="title_list">',r="";$.each(i,(function(e,n){var i="";n.author!=r&&(r=n.author,i='<a name="'+n.author+'"/>'),o+="<li>"+i+n.author+', <a href="#" onclick="search_result(this,'+n.id+",-1,'"+t+"');return false\">"+n.title+"</a></li>"})),o+="</ul>";var a=$(e).parents(".window_panel"),s=$(a).position().top+20*Math.random(),l=$(a).position().left;s<5&&(s=5),(l=l+250+20+20*Math.random())+250>$(document).width()&&(l-=500);var d=openWindow(l,s,2e3,250,300,o,"","result_box",!0);scrollToAnchor(n,$(d.window.getContainer()).find(".window_frame"),d.window.getContainer().attr("id"))}}function thesaurusSyns(e){$.getJSON(THES_JSON+e+"/json",(function(e){var t="";for(var n in e)null!=n&&$.each(e[n].syn,(function(e,n){e<5&&(t+='<li><a href="#" onclick="searchByTerm(\''+n+"');return false;\"> "+n+"</li>",e++)}));suggestionList.length>0&&(suggestionList+="<li>&nbsp;</li>"),suggestionList+=t,$(".write_container .suggestions").html('<ul class="wiki_suggestions">'+suggestionList+"</ul>")}))}function searchWikiminer(e){processArticleJSON(BY_TERM_JSON+e,e)}function processArticleJSON(e,t){$.ajax({url:"https://en.wikipedia.org/w/api.php",jsonp:"callback",dataType:"jsonp",data:{action:"query",list:"search",srsearch:t,format:"json"},xhrFields:{withCredentials:!0},success:function(e){console.log("processArticleJSON:",e),console.log("processArticleJSON snippet:",e.query.search[0].snippet),openWikiWindow(e,0,0,e.query.search[0].pageid)}}),$.getJSON(e,(function(e){json_cache=e;var t=sortJSON(e,"relatedness");if(null!=t){var n="";$.each(t,(function(e,t){e<7&&(n+='<li><a href="#" onclick="queryWikipediaApiById(0,0,\''+t.id+"');return false;\"> "+t.title.toLowerCase()+" </a></li>",e++)})),suggestionList.length>0&&(suggestionList+="<li>&nbsp;</li>"),suggestionList+=n,$(".write_container .suggestions").html('<ul class="wiki_suggestions">'+suggestionList+"</ul>")}}))}function save_to_desktop(){var e=$(".window_frame #write_textarea").val();window.open("save.php?method=desktop&content="+e,"_self")}function send_email(){var e=$(".window_frame #write_textarea").val(),t=prompt("email address (separated by comma)");null!=t&&""!=t&&$.ajax({url:"save.php?method=email&content="+e+"&to="+t,context:document.body}).done((function(){console.log("ajax done")}))}function contact_email(){var e=$(".window_frame #write_textarea").val(),t="dehens.sven@gmail.com";""!=e&&$.ajax({url:"save.php?method=email&content="+e+"&to="+t,context:document.body}).done((function(){console.log("ajax done"),alert("thanks")}))}var searchHintCount=0;function searchHint(e){e?($(".search_hint").show(),searchHintCount++):$(".search_hint").hide()}function searchKeyup(e,t){$(".hint_screenshot").css("display","none"),13==t.keyCode&&(search(e),no_action=!1)}
